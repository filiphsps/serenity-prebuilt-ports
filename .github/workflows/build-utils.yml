name: Build minimum utilities

on:
  push:
  schedule:
    - cron: "0 0 * * *"

jobs:
  build-utils:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: "ğŸ“¦ Install Ubuntu dependencies"
        run: |
          sudo add-apt-repository -y ppa:canonical-server/server-backports
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          sudo apt-get install -y ccache e2fsprogs gcc-11 g++-11 libstdc++-11-dev libmpfr-dev libmpc-dev ninja-build qemu-utils qemu-system-i386 unzip

      - name: "ğŸ Clone serenity repo"
        run: git clone https://github.com/SerenityOS/serenity

      - name: "ğŸ’¾ Cache toolchain & build"
        uses: actions/cache@v2
        with:
          key: ${{ runner.os }}-cache
          path: |
            ./serenity/Build/
            ./serenity/Toolchain/Build
            ./serenity/Ports/**/*.tar.*

      - name: "ğŸ”¨ Build serenity"
        run: ./Meta/serenity.sh build i686
        working-directory: ./serenity/

      - name: "ğŸ”¨ Build gcc"
        run: ./package.sh
        working-directory: ./serenity/Ports/gcc/

      - name: "ğŸ”¨ Build make"
        run: ./package.sh
        working-directory: ./serenity/Ports/make/

      - name: "ğŸ”¨ Build binutils"
        run: ./package.sh
        working-directory: ./serenity/Ports/binutils/

      - name: "ğŸ”¨ Build git"
        run: ./package.sh
        working-directory: ./serenity/Ports/git/

      - name: "ğŸ¤ Compress utilities"
        run: tar -C ./serenity/Build/i686/Root/usr/local/bin -cvf utilities-i686.tar.gz .

      - name: "ğŸŒ Upload binaries"
        uses: skx/github-action-publish-binaries@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: "utilities-i686.tar.gz"
